// Prisma Schema for 豆苗農家の発注・在庫・生産管理システム
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ユーザー管理
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      UserRole @default(WORKER)
  password  String // ハッシュ化されたパスワード
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  productions Production[] // 生産計画の担当者
  shipments   Shipment[] // 出荷の担当者

  @@map("users")
}

// ユーザーロール
enum UserRole {
  ADMIN // 管理者
  FACTORY_MANAGER // 工場長
  WORKER // 作業員
  CUSTOMER_USER // 納入先ユーザー
}

// 納入先（顧客）
model Customer {
  id              String   @id @default(cuid())
  code            String   @unique // 顧客コード
  name            String // 例: 新潟中央青果、R&Cなかの青果
  contactName     String? // 担当者名
  phone           String?
  email           String?
  postalCode      String? // 郵便番号
  address         String? // 住所
  deliveryAddress String? // 配送先住所（本社と異なる場合）
  notes           String? // 備考
  isActive        Boolean  @default(true) // 取引中かどうか
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // リレーション
  orders    Order[]
  shipments Shipment[]

  @@map("customers")
}

// 商品
model Product {
  id          String   @id @default(cuid())
  code        String   @unique // 商品コード
  name        String // 例: 豆苗、カイワレS、カイワレW、ブロッコリー
  description String? // 商品説明
  unit        String   @default("パック") // 単位
  unitPrice   Decimal  @db.Decimal(10, 2) // 単価
  growthDays  Int // 標準栽培日数
  isActive    Boolean  @default(true) // 販売中かどうか
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  orderItems    OrderItem[]
  inventories   Inventory[]
  productions   Production[]
  shipmentItems ShipmentItem[]

  @@map("products")
}

// 注文
model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique // 注文番号
  customerId   String
  orderDate    DateTime    @default(now()) // 注文日
  deliveryDate DateTime // 希望納品日
  status       OrderStatus @default(PENDING)
  totalAmount  Decimal     @db.Decimal(10, 2) // 合計金額
  notes        String? // 備考
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // リレーション
  customer   Customer    @relation(fields: [customerId], references: [id])
  orderItems OrderItem[]

  @@index([customerId])
  @@index([orderDate])
  @@index([deliveryDate])
  @@map("orders")
}

// 注文ステータス
enum OrderStatus {
  PENDING // 保留中
  CONFIRMED // 確定
  IN_PRODUCTION // 生産中
  READY // 出荷準備完了
  SHIPPED // 出荷済み
  DELIVERED // 配送完了
  CANCELLED // キャンセル
}

// 注文明細
model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  quantity  Int // 数量
  unitPrice Decimal  @db.Decimal(10, 2) // 単価
  amount    Decimal  @db.Decimal(10, 2) // 小計
  notes     String? // 備考
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// 生産計画
model Production {
  id          String           @id @default(cuid())
  productId   String
  lotNumber   String           @unique // ロット番号
  seedingDate DateTime // 種付け日
  harvestDate DateTime // 収穫予定日
  quantity    Int // 生産数量
  status      ProductionStatus @default(PLANNED)
  assignedTo  String? // 担当者ID
  notes       String? // 備考
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // リレーション
  product     Product     @relation(fields: [productId], references: [id])
  user        User?       @relation(fields: [assignedTo], references: [id])
  inventories Inventory[]

  @@index([productId])
  @@index([seedingDate])
  @@index([harvestDate])
  @@index([assignedTo])
  @@map("productions")
}

// 生産ステータス
enum ProductionStatus {
  PLANNED // 計画中
  SEEDING // 種付け済み
  GROWING // 育成中
  HARVESTED // 収穫済み
  CANCELLED // キャンセル
}

// 在庫
model Inventory {
  id           String          @id @default(cuid())
  productId    String
  productionId String? // 生産計画ID（ロット管理）
  lotNumber    String // ロット番号
  quantity     Int // 在庫数量
  location     String? // 保管場所
  status       InventoryStatus @default(AVAILABLE)
  expiryDate   DateTime? // 消費期限
  notes        String? // 備考
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // リレーション
  product       Product        @relation(fields: [productId], references: [id])
  production    Production?    @relation(fields: [productionId], references: [id])
  shipmentItems ShipmentItem[]

  @@index([productId])
  @@index([productionId])
  @@index([lotNumber])
  @@index([status])
  @@map("inventories")
}

// 在庫ステータス
enum InventoryStatus {
  AVAILABLE // 利用可能
  RESERVED // 予約済み
  SHIPPED // 出荷済み
  DAMAGED // 破損
  EXPIRED // 期限切れ
}

// 出荷
model Shipment {
  id             String         @id @default(cuid())
  shipmentNumber String         @unique // 出荷番号
  customerId     String
  shipmentDate   DateTime // 出荷日
  deliveryDate   DateTime? // 配送予定日
  status         ShipmentStatus @default(PREPARING)
  assignedTo     String? // 担当者ID
  totalAmount    Decimal        @db.Decimal(10, 2) // 合計金額
  notes          String? // 備考
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // リレーション
  customer      Customer       @relation(fields: [customerId], references: [id])
  user          User?          @relation(fields: [assignedTo], references: [id])
  shipmentItems ShipmentItem[]

  @@index([customerId])
  @@index([shipmentDate])
  @@index([assignedTo])
  @@map("shipments")
}

// 出荷ステータス
enum ShipmentStatus {
  PREPARING // 準備中
  READY // 出荷準備完了
  SHIPPED // 出荷済み
  DELIVERED // 配送完了
  CANCELLED // キャンセル
}

// 出荷明細
model ShipmentItem {
  id          String   @id @default(cuid())
  shipmentId  String
  productId   String
  inventoryId String? // 在庫ID（ロット追跡用）
  quantity    Int // 数量
  unitPrice   Decimal  @db.Decimal(10, 2) // 単価
  amount      Decimal  @db.Decimal(10, 2) // 小計
  notes       String? // 備考
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  shipment  Shipment   @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  product   Product    @relation(fields: [productId], references: [id])
  inventory Inventory? @relation(fields: [inventoryId], references: [id])

  @@index([shipmentId])
  @@index([productId])
  @@index([inventoryId])
  @@map("shipment_items")
}
